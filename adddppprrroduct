<%- include("../../views/partials/user/header") %>

<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 0;
        color: #0F1111;
    }

    .checkout-container {
        display: flex;
        width: 90%;
        max-width: 1200px;
        margin: 20px auto;
        gap: 20px;
    }

    .left-section, .right-section {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    .left-section {
        flex: 2;
    }

    .right-section {
        flex: 1;
    }

    h2, h3 {
        color: #0F1111;
        font-size: 20px;
        margin-bottom: 15px;
    }

    h4 {
        font-size: 16px;
        color: #0F1111;
        margin-bottom: 10px;
    }

    .order-summary {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 4px;
        border: 1px solid #ddd;
        margin-bottom: 20px;
    }

    .order-summary p {
        margin: 5px 0;
        font-size: 14px;
        color: #565959;
    }

    .order-summary h3 {
        margin-top: 10px;
        font-size: 18px;
        color: #0F1111;
    }

    .payment-method {
        margin-bottom: 20px;
    }

    .payment-method input[type="radio"] {
        margin-right: 10px;
    }

    .payment-method label {
        font-size: 14px;
        color: #0F1111;
    }

    .apply-btn, .submit-btn {
        background-color: #FFD814;
        border: 1px solid #FCD200;
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 8px;
        width: 100%;
        font-size: 14px;
        color: #0F1111;
        text-align: center;
        margin-top: 10px;
    }

    .apply-btn:hover, .submit-btn:hover {
        background-color: #F7CA00;
    }

    .address-card {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 10px;
        cursor: pointer;
    }

    .address-card:hover {
        background-color: #f9f9f9;
    }

    .address-card h4 {
        margin: 0;
        font-size: 16px;
    }

    .address-card p {
        margin: 5px 0;
        font-size: 14px;
        color: #565959;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 4px;
        width: 400px;
        max-width: 90%;
    }

    .modal-content button {
        background-color: #FFD814;
        border: 1px solid #FCD200;
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 8px;
        font-size: 14px;
        color: #0F1111;
        margin-top: 10px;
    }

    .modal-content button:hover {
        background-color: #F7CA00;
    }

    #addAddressForm {
        display: none;
        margin-top: 20px;
    }

    #addAddressForm input {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    #addAddressForm button {
        background-color: #FFD814;
        border: 1px solid #FCD200;
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 8px;
        font-size: 14px;
        color: #0F1111;
    }

    #addAddressForm button:hover {
        background-color: #F7CA00;
    }
    .error-message {
        color: red;
        font-size: 12px;
        margin-bottom: 10px;
        display: block;
    }
</style>

<div class="checkout-container">
    <div class="left-section">
        <h2>Delivering to <b><%= defaultAddress ? defaultAddress.name : 'Select Address' %></b></h2>
        <p>
            <%= defaultAddress ? `${defaultAddress.addressLine1}, ${defaultAddress.city}, ${defaultAddress.state}, ${defaultAddress.postalCode}, ${defaultAddress.country}` : 'No address selected' %>
        </p>
        <a href="#" onclick="openAddressModal()" style="color: #007185; text-decoration: none;">Change</a> | 
        <a href="#" style="color: #007185; text-decoration: none;">Add delivery instructions</a>

        <!-- Address Selection Modal -->
        <div id="addressModal" class="modal">
            <div class="modal-content">
                <h3>Select Delivery Address</h3>
                <% addresses.forEach(address => { %>
                    <div class="address-card">
                        <input type="radio" name="selectedAddress" value="<%= address._id %>"
                               <%= defaultAddress && defaultAddress._id === address._id ? 'checked' : '' %>
                               onchange="setSelectedAddress('<%= address._id %>', '<%= address.name %>', '<%= address.addressLine1 %>, <%= address.city %>, <%= address.state %> - <%= address.postalCode %>')">
                        <h4><%= address.name %></h4>
                        <p><%= address.addressLine1 %>, <%= address.city %>, <%= address.state %> - <%= address.postalCode %></p>
                        <p><%= address.country %></p>
                        <p>Phone: <%= address.phoneNumber %></p>
                        <form action="/checkout/editAddress/<%= address._id %>" method="GET">
                            <button type="submit" class="edit-btn">Edit</button>
                        </form>
                        
                         
                    </div>
                    <% }); %>
                    <button onclick="closeAddressModal()">Done</button>
                </div>
            </div>

        <!-- Add Address Button -->
        <button onclick="showAddAddressForm()" style="background-color: #FFD814; border: 1px solid #FCD200; padding: 10px 15px; cursor: pointer; border-radius: 8px; font-size: 14px; color: #0F1111; margin-top: 10px;">+ Add Address</button>

        <!-- Add New Address Form -->
        <div id="addAddressForm">
            <h3>Add a New Address</h3>
            <form id="addressForm" action="/checkout/addAddress" method="POST" onsubmit="return validateAddressForm()">
                <input type="text" name="name" id="name" placeholder="Full Name" required>
                <span class="error-message" id="nameError"></span>
        
                <input type="text" name="addressLine1" id="addressLine1" placeholder="Address Line 1" required>
                <span class="error-message" id="addressLine1Error"></span>
        
                <input type="text" name="city" id="city" placeholder="City" required>
                <span class="error-message" id="cityError"></span>
        
                <input type="text" name="state" id="state" placeholder="State" required>
                <span class="error-message" id="stateError"></span>
        
                <input type="text" name="postalCode" id="postalCode" placeholder="Postal Code" required>
                <span class="error-message" id="postalCodeError"></span>
        
                <input type="text" name="country" id="country" placeholder="Country" required>
                <span class="error-message" id="countryError"></span>
        
                <input type="text" name="phoneNumber" id="phoneNumber" placeholder="Phone Number" required>
                <span class="error-message" id="phoneNumberError"></span>
        
                <button type="submit">Save Address</button>
            </form>
        </div>
        
         <h3>Payment method</h3>
        <div class="payment-method">
            <input type="radio" name="payment" value="canarabank"> Canara Bank **2265<br>
            <input type="radio" name="payment" value="credit_card"> Credit or debit card<br>
            <input type="radio" name="payment" value="cod"> Cash on Delivery (COD) <br>
            
        </div> 
    </div>

    <div class="right-section">
        <h3>Order Summary</h3>
        <div class="order-summary">
            <p>Items: ₹<%= totalAmount %></p>
            <p>Delivery: ₹40</p>
            <p>Cash/Pay on Delivery Fee: ₹7</p>
            <h3>Order Total: ₹<%= totalAmount+47 %></h3>
        </div>
        <form action="/checkout/createOrder" method="POST">
            <input type="hidden" id="selectedAddressId" name="addressId" value="<%= defaultAddress ? defaultAddress._id : '' %>">
            <input type="hidden" name="paymentMethod" id="selectedPaymentMethod">
            <button type="submit" class="submit-btn">Place Order</button>
        </form>
    </div>
</div>

<script>
function openAddressModal() {
    document.getElementById('addressModal').style.display = 'flex';
}

function closeAddressModal() {
    document.getElementById('addressModal').style.display = 'none';
}

function setSelectedAddress(id, name, details) {
    document.querySelector("h2").innerHTML = `Delivering to <b>${name}</b>`;
    document.querySelector("p").innerText = details;
    document.getElementById("selectedAddressId").value = id;
    closeAddressModal();
}

function showAddAddressForm() {
    document.getElementById('addAddressForm').style.display = 'block';
}
document.querySelectorAll('input[name="payment"]').forEach(radio => {
    radio.addEventListener('change', function () {
        document.getElementById('selectedPaymentMethod').value = this.value;
        document.querySelector('.submit-btn').disabled = false; // Enable Place Order button
    });
});

// Disable Place Order button initially
document.querySelector('.submit-btn').disabled = true;



function validateAddressForm() {
    let isValid = true;

    // Reset all error messages
    document.querySelectorAll('.error-message').forEach(el => el.innerText = '');

    // Get form values
    const name = document.getElementById('name').value.trim();
    const addressLine1 = document.getElementById('addressLine1').value.trim();
    const city = document.getElementById('city').value.trim();
    const state = document.getElementById('state').value.trim();
    const postalCode = document.getElementById('postalCode').value.trim();
    const country = document.getElementById('country').value.trim();
    const phoneNumber = document.getElementById('phoneNumber').value.trim();

    // Regular Expressions
    const nameRegex = /^[A-Za-z\s]+$/;  // Only alphabets and spaces
    const phoneRegex = /^[0-9]{10}$/;   // Exactly 10 digits
    const postalRegex = /^[0-9]{6}$/;   // Exactly 6 digits

    // Validation checks
    if (name === '') {
        document.getElementById('nameError').innerText = 'Full name is required.';
        isValid = false;
    } else if (!nameRegex.test(name)) {
        document.getElementById('nameError').innerText = 'Name should contain only alphabets.';
        isValid = false;
    }

    if (addressLine1 === '') {
        document.getElementById('addressLine1Error').innerText = 'Address is required.';
        isValid = false;
    }

    if (city === '') {
        document.getElementById('cityError').innerText = 'City is required.';
        isValid = false;
    }

    if (state === '') {
        document.getElementById('stateError').innerText = 'State is required.';
        isValid = false;
    }

    if (postalCode === '') {
        document.getElementById('postalCodeError').innerText = 'Postal code is required.';
        isValid = false;
    } else if (!postalRegex.test(postalCode)) {
        document.getElementById('postalCodeError').innerText = 'Postal code must be exactly 6 digits.';
        isValid = false;
    }

    if (country === '') {
        document.getElementById('countryError').innerText = 'Country is required.';
        isValid = false;
    }

    if (phoneNumber === '') {
        document.getElementById('phoneNumberError').innerText = 'Phone number is required.';
        isValid = false;
    } else if (!phoneRegex.test(phoneNumber)) {
        document.getElementById('phoneNumberError').innerText = 'Phone number must be exactly 10 digits.';
        isValid = false;
    }

    return isValid; // Prevents form submission if false
}


</script>

<%- include("../../views/partials/user/footer") %>